---
import DivBox1 from '@/components/atomos/DivBox1.astro';
import db from '@/db';
import { users, usersCentrosMedicos } from '@/db/schema';
import { eq } from 'drizzle-orm';
import ConfeccionTablaUsuarios from './ConfeccionTablaUsuarios';

const { session, user } = Astro.locals;
let usersData = [];
try {
  const dataDB = await db
    .select({
      id: users.id,
      nombre: users.nombre,
      apellido: users.apellido,
      email: users.email,
      especialidad: users.especialidad,
      mp: users.mp,
      rol: users.rol,
      celular: users.celular,
    })
    .from(usersCentrosMedicos)
    .innerJoin(users, eq(users.id, usersCentrosMedicos.userId))
    .where(eq(usersCentrosMedicos.centroMedicoId, user?.centroMedicoId));

  usersData = dataDB.map(user => {
    return {
      href: `/dashboard/ajustes/usuarios/${user.id}`,
      id: user.id,
      nombreApellido: `${user.nombre}  ${user.apellido} `,
      email: user.email,
      especialidad: user.especialidad,
      mp: user.mp,
      rol: user.rol,
      celular: user.celular,
    };
  });
} catch (error) {
  console.log(error);
}
---

<DivBox1 styleDiv="w-full min-w-0 overflow-x-auto">
  <ConfeccionTablaUsuarios usersData={usersData} client:load />
</DivBox1>
