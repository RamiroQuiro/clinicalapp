---
import { desc, eq } from "drizzle-orm";
import MainDashboard from "../../../../components/atomos/MainDashboard.astro";
import LayoutDash from "../../../../components/layouts/LayoutDash.astro";
import HistorialVisitaPaciente from "../../../../components/organismo/HistorialVisitaPaciente.astro";
import MedicacionFichaPaciente from "../../../../components/organismo/MedicacionFichaPaciente.astro";
import ObservacionesDoctorHistorial from "../../../../components/organismo/ObservacionesDoctorHistorial.astro";
import PacienteHeader from "../../../../components/organismo/PacienteHeader.astro";
import db from "../../../../db";
import { diagnostico, historiaClinica, medicamento, pacientes, tratamiento } from "../../../../db/schema";
import type { pacienteType } from "../../../../types";
import Antecedentes from "../../../../components/organismo/Antecedentes.astro";

const { pacienteId } = Astro.params;

let pacienteData: pacienteType = {};
let medicamentosData = {};
let historialVisitas=[]
const medicalHistory = [
  {
    condition: "Hipertensión Arterial",
    diagnosisDate: "15 Enero 2022",
    status: "Controlado",
    type: "personal",
    critical: true,
  },
  {
    condition: "Diabetes Tipo 2",
    diagnosisDate: "3 Marzo 2021",
    status: "En tratamiento",
    type: "personal",
  },
  {
    condition: "Antecedente de Cáncer de Mama",
    diagnosisDate: "10 Enero 2020",
    status: "Familiar",
    type: "family",
  },
];

const recentVisits = [
  {
    date: "12 Mar 2024",
    reason: "Control rutinario",
    doctor: "Dr. Juan Pérez",
    department: "Medicina General",
  },
  {
    date: "25 Feb 2024",
    reason: "Dolor de cabeza",
    doctor: "Dra. Ana López",
    department: "Neurología",
  },
];


const doctorNotes = [
  {
    date: "12 Mar 2024",
    doctor: "Dr. Juan Pérez",
    content:
      "Paciente presenta mejora en niveles de glucosa. Se mantiene tratamiento actual. Próximo control en 3 meses.",
  },
  {
    date: "25 Feb 2024",
    doctor: "Dra. Ana López",
    content:
      "Cefalea tensional. Se recomienda ejercicios de relajación y seguimiento de patrones de sueño. Control en 2 semanas si persisten los síntomas.",
  },
];

try {
  pacienteData = (
    await db.select().from(pacientes).where(eq(pacientes.id, pacienteId))
  ).at(0);
  medicamentosData = await db
    .select()
    .from(medicamento)
    .where(eq(medicamento.pacienteId, pacienteId))
    .orderBy(desc(medicamento.created_at));
    import { sql } from "drizzle-orm";

 historialVisitas = await db
  .select({
    fecha: historiaClinica.created_at,
    motivo: historiaClinica.motivoConsulta,
    diagnosticos: sql`GROUP_CONCAT(${diagnostico.diagnostico}, ', ')`.as("diagnosticos"),
    tratamiento: tratamiento.tratamiento,
  })
  .from(historiaClinica)
  .rightJoin(tratamiento, eq(tratamiento.historiaClinicaId, historiaClinica.id))
  .rightJoin(diagnostico, eq(diagnostico.historiaClinicaId, historiaClinica.id))
  .where(eq(historiaClinica.pacienteId, pacienteId))
  .groupBy(historiaClinica.id)
  .orderBy(desc(historiaClinica.created_at)); // Agrupa por la historia clínica
  

//  console.log("este son los historialVisitas", historialVisitas);

  if (!pacienteData) {
    console.log("paciente no encontrado");
    return;
  }
} catch (error) {
  console.log(error);
}

// const {patientData,medicalHistory,recentVisits,medications,doctorNotes}=Astro.props
---

<LayoutDash>
  <MainDashboard>
    <div class="container py-4 px-2 flex flex-col w-full">
      <PacienteHeader {...pacienteData} />

      <div class="flex  gap-4">
        <div class="flex-1">
          <Antecedentes conditions={medicalHistory} />
          <HistorialVisitaPaciente visitas={historialVisitas} />
        </div>
        <div class="flex-1">
          <MedicacionFichaPaciente medicacion={medicamentosData} />
          <ObservacionesDoctorHistorial notes={doctorNotes} />
        </div>
      </div>
    </div>
  </MainDashboard>
</LayoutDash>
