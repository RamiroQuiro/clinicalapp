---
import { desc, eq, sql } from "drizzle-orm";
import MainDashboard from "../../../../components/atomos/MainDashboard.astro";
import LayoutDash from "../../../../components/layouts/LayoutDash.astro";
import HistorialVisitaPaciente from "../../../../components/organismo/HistorialVisitaPaciente.astro";
import db from "../../../../db";
import {
  diagnostico,
  medicamento,
  pacientes,
  antecedente,
  archivosAdjuntos,
  atenciones,
} from "../../../../db/schema";
import type {
  AntecedentesMedicosProps,
  DocumentosAdjuntosProps,
  pacienteType,
} from "../../../../types";
import PacienteHeader from "../../../../components/organismo/PacienteHeader.astro";
import MedicacionFichaPaciente from "../../../../components/organismo/MedicacionFichaPaciente.astro";
import Antecedentes from "../../../../components/organismo/Antecedentes.astro";
import Div1Atencion from "../../../../components/atomos/Div1Atencion.astro";
import ArchivosAdjuntosPaciente from "../../../../components/organismo/ArchivosAdjuntosPaciente.astro";
import DivBox1 from "../../../../components/atomos/DivBox1.astro";
import NotasMedicas from "../../../../components/organismo/NotasMedicas.astro";
import { notasMedicas } from "../../../../db/schema/notasMedicas";
import ContenedorCharts from "../../../../components/moleculas/ContenedorCharts.astro";
import Button1 from "../../../../components/atomos/Button1.astro";

const { pacienteId } = Astro.params;
const userId = "sakflsdk";

let pacienteData: pacienteType = {};
let medicamentosData = {};
let arrayAntecedente: AntecedentesMedicosProps = [];
let historialVisitas = [];
let arrayArchivosAdjuntos: DocumentosAdjuntosProps = [];
let arrayNotasMedicas = [];

try {
  pacienteData = (
    await db.select().from(pacientes).where(eq(pacientes.id, pacienteId))
  ).at(0);
  medicamentosData = await db
    .select()
    .from(medicamento)
    .where(eq(medicamento.pacienteId, pacienteId))
    .orderBy(desc(medicamento.created_at));

  historialVisitas = await db
    .select({
      fecha: atenciones.created_at,
      motivo: atenciones.motivoConsulta,
      diagnosticos: sql`GROUP_CONCAT(${diagnostico.diagnostico}, ', ')`.as(
        "diagnosticos"
      ),
      tratamiento: atenciones.tratamiento,
    })
    .from(atenciones)
    .where(eq(atenciones.pacienteId, pacienteId))
    .groupBy(atenciones.id)
    .orderBy(desc(atenciones.created_at)); // Agrupa por la historia clínica

  arrayAntecedente = await db
    .select()
    .from(antecedente)
    .where(eq(antecedente.pacienteId, pacienteId));

  arrayArchivosAdjuntos = await db
    .select()
    .from(archivosAdjuntos)
    .where(eq(archivosAdjuntos.pacienteId, pacienteId))
    .orderBy(desc(archivosAdjuntos.created_at));
  arrayNotasMedicas = await db
    .select()
    .from(notasMedicas)
    .where(eq(notasMedicas.pacienteId, pacienteId))
    .orderBy(desc(notasMedicas.created_at));

  console.log("este son los historialVisitas", historialVisitas);

  if (!pacienteData) {
    console.log("paciente no encontrado");
    return;
  }
} catch (error) {
  console.log(error);
}

const {patientData,medicalHistory,recentVisits,medications,doctorNotes}=Astro.props
---

<LayoutDash>
  <MainDashboard h1="Ficha del paciente">
    <div class="container py-4 gap-2 px-2 flex flex-col w- w-[97%]">
      <PacienteHeader {...pacienteData} />
      <!-- <ContenedoresProgresoHistorial client:load/> -->
      <DivBox1 class="w-full text-primary-texto">
        <details class="w-full tex-center flex items-center justify-center">
          <summary
            class="px-2 py-0 bg-primary-bacSidebar shadow- shadow-primary-100 cursor-pointer w-full text-sm font-semibold text-center flex items-center justify-between"
            ><p>Pogresos</p><Button1>ver más</Button1></summary
          >
          <ContenedorCharts />
        </details>
      </DivBox1>
      <div class="flex w-full items-start justify-normal gap-4">
        <Div1Atencion>
          <DivBox1>
            <Antecedentes antecedentes={arrayAntecedente} />
          </DivBox1>
          <HistorialVisitaPaciente visitas={historialVisitas} />
        </Div1Atencion>
        <Div1Atencion>
          <MedicacionFichaPaciente medicacion={medicamentosData} />
          <ArchivosAdjuntosPaciente documentos={arrayArchivosAdjuntos} />
          <NotasMedicas userId={userId} notes={arrayNotasMedicas} />
        </Div1Atencion>
      </div>
    </div>
  </MainDashboard>
</LayoutDash>
